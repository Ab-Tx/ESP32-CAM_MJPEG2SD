# ESP32-CAM_MJPEG2SD
ESP32 Camera extension to record JPEGs to SD card as MPJEG file and playback to browser 

## Purpose
The MPJEG format contains the original JPEG images but displays them as a video. MJPEG playback is not rate controlled, so playback to a browser runs faster than the original recording rate. MJPEG files can also be played on video apps or converted into rate controlled AVI or MKV files etc.

Saving a set of JPEGs as a single file is faster than as individual files and is easier to manage, particularly for small image sizes. Actual rate depends on quality and size of SD card. A generic 4GB SDHC labelled as Class 6 was 3 times slower than a Sandisk SDHC Class 2. The ESP32 SD_MMC library appears to max out at around 300kB/s write. The following recording rates were achieved on a freshly formatted Sandisk 4GB SDHC Class 2 using SD_MMC 1 line mode on a AI Thinker OV2640 board, set to maximum JPEG quality and the configuration given in the __To maximise rate__ section below.

Frame Size | OV2640 camera max fps | mjpeg2sd max fps
------------ | ------------- | -------------
QQVGA | 50 | 35 
HQVGA | 50 | 30
QVGA | 50 | 25
CIF | 50 | 20
VGA | 25 | 15
SVGA | 25 | 10
XGA | 6.25 | 6
SXGA | 6.25 | 4
UXGA | 6.25 | 2

## Design

The ESP32 Cam module has 4MB of pSRAM which is used to buffer the camera frames and the construction of the MJPEG file to minimise the number of SD file writes, and optimise the writes by aligning them with the SD card cluster size. For playback the MJPEG is read and sent to the browser using cluster size buffers.

The SD card can be used in either __MMC 1 line__ mode (default) or __MMC 4 line__ mode. The __MMC 1 line__ mode is practically as fast as __MMC 4 line__ and frees up pin 4 (connected to onboard Lamp), and pin 12 which can be used for eg a PIR.  
  
An MJPEG recording is generated by holding a given pin to ground (kept high by internal pullup when released).  
The pin to use is:
* pin 12 for 1 line mode
* pin 33 for 4 line mode

The MJPEG files are named using a date time format __YYYYMMDD_HHMMSS__, with added frame size, recording rate and duration, eg __20200130_201015_VGA_14_60.mjpeg___, and stored in a per day folder __YYYYMMDD__.  
The ESP32 time is set from an NTP server. Set timezone as appropriate.

Do not record a MJPEG whilst simultaneously streaming to browser otherwise a crash will occur on frame buffer contention.


## Installation and Use

The example sketch `ESP32-CAM_MJPEG2SD.ino` is derived from the `CameraWebServer.ino` sketch which is included in the Arduino ESP32 library. Two additional files are supplied.
* `mjpeg2sd.cpp` contains the additional code
* `sdbrowser.h` contains the control web page

Additional code has been added to the original file `app_httpd.cpp` to handle the extra browser interface.

To set the recording parameters, enter `<ip address>/sd` on the browser to bring up the control page, where:
* `Frame Rate` is the required frames per second, or 0 for maximum achievable
* `Min Frames` is the minimum number of frames to be captured or the file is deleted
* `Debug` if checked generates additional logging

To playback a recording, first select the day folder from the drop down list, then the actual file, which then displays the camera settings page. 
Press __Start Stream__ button to playback the selected file. 


## To maximise rate

To get maximum frame rate on OV2640, in `ESP32-CAM_MJPEG2SD.ino`:
* `config.xclk_freq_hz = 10000000;` This is faster than the default `20000000` 
* `config.fb_count = 8` to provide sufficient buffering between SD writes for smaller frame sizes 

In `mjpeg2sd.cpp` change `#define CLUSTERSIZE 32768` if the SD card cluster size is not 32kB.

